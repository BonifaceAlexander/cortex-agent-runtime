{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Cortex Agent Runtime","text":"<p>Cortex Agent Runtime is a lightweight, Python-based runtime for orchestrating AI agents within the Snowflake Data Cloud. It provides a control plane for defining, executing, and monitoring agents directly where your data lives.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Snowflake Native: Agents run and persist state directly in Snowflake tables.</li> <li>High-Scale Engine: Parallel execution worker pool handling multiple agents concurrently.</li> <li>Disaster Recovery: Resume interrupted runs deterministically from the last successful step.</li> <li>Dynamic Tooling: Registry-based execution of real Python tools, not just mocks.</li> <li>Configurable: Environment-based tuning for worker pools (<code>CR_MAX_WORKERS</code>) and batch sizes (<code>CR_FETCH_LIMIT</code>).</li> <li>SQL-Based Management: Define and monitor agents using simple SQL tables.</li> <li>Extensible: Protocol-based support for Cortex and Mock providers.</li> </ul>"},{"location":"#getting-started","title":"Getting Started","text":"<p>Ready to jump in? Check out the Getting Started guide.</p>"},{"location":"#how-it-works","title":"How it Works","text":"<ol> <li>Define: Create an <code>agent.yaml</code> definition.</li> <li>Register: Upsert the definition to the <code>AGENT_DEFINITIONS</code> table.</li> <li>Run: Insert a run request into <code>AGENT_RUNS</code>.</li> <li>Execute: The Runtime polls for pending runs and executes the defined steps.</li> </ol> <pre><code>graph TD\n    User[User] --&gt;|Upsert Definition| DB[(Snowflake DB)]\n    User --&gt;|Insert Run| DB\n\n    subgraph \"Cortex Runtime\"\n        Engine[Execution Engine] --&gt;|Poll Pending Runs| DB\n        Engine --&gt;|Fetch Definition| DB\n        Engine --&gt;|Execute Steps| LLM[Cortex LLM]\n        Engine --&gt;|Log Steps/Updates| DB\n    end\n\n    LLM --&gt;|Response| Engine</code></pre>"},{"location":"architecture/","title":"System Design &amp; Architecture","text":""},{"location":"architecture/#the-core-mental-model","title":"The Core Mental Model","text":"<p>\u201cThe runtime treats Snowflake as the control plane, Cortex as the inference engine, and the execution layer as a stateless orchestrator.\u201d</p>"},{"location":"architecture/#snowflake-control-plane-state","title":"\ud83e\udde0 Snowflake = Control Plane + State","text":"<p>Snowflake is the System of Record. - Agent Definitions: Agents are declared as data, not code. - Agent Memory: Conversation history, tool outputs, reasoning traces. - Observability: Logs, metrics, costs.</p>"},{"location":"architecture/#runtime-execution-engine-external","title":"\u2699\ufe0f Runtime = Execution Engine (External)","text":"<p>The runtime is an external service/process that: 1.  Reads agent definitions from Snowflake. 2.  Executes steps deterministically using the Cortex Adapter. 3.  Writes results back to Snowflake (runs, steps, memory).</p>"},{"location":"architecture/#1-snowflake-schema-design","title":"1\ufe0f\u20e3 Snowflake Schema Design","text":"<p>Everything important is data, queryable with SQL.</p>"},{"location":"architecture/#agent_definitions","title":"\ud83d\udd39 AGENT_DEFINITIONS","text":"<p>Defines what an agent is. Config-first, versioned, auditable. <pre><code>CREATE TABLE AGENT_DEFINITIONS (\n  agent_id STRING,\n  agent_name STRING,\n  version STRING,\n  definition_yaml VARIANT,     -- The full config\n  model STRING,                -- Cortex model reference\n  retry_policy VARIANT,\n  created_at TIMESTAMP,\n  updated_at TIMESTAMP,\n  status STRING                -- active / deprecated\n);\n</code></pre></p>"},{"location":"architecture/#agent_runs","title":"\ud83d\udd39 AGENT_RUNS","text":"<p>One row per execution. Tracks cost, latency, and status. <pre><code>CREATE TABLE AGENT_RUNS (\n  run_id STRING,\n  agent_id STRING,\n  agent_version STRING,\n  status STRING,               -- running / failed / completed\n  start_time TIMESTAMP,\n  end_time TIMESTAMP,\n  triggered_by STRING,         -- user / api / schedule\n  total_tokens NUMBER,\n  total_cost NUMBER,\n  error_message STRING\n);\n</code></pre></p>"},{"location":"architecture/#agent_steps","title":"\ud83d\udd39 AGENT_STEPS","text":"<p>Fine-grained execution trace for debugging and forensics. <pre><code>CREATE TABLE AGENT_STEPS (\n  run_id STRING,\n  step_index INTEGER,          -- 0-indexed position\n  step_name STRING,\n  input VARIANT,\n  output VARIANT,\n  model STRING,                -- Cortex model used\n  tokens_used NUMBER,          -- Cost tracking\n  latency_ms NUMBER,\n  status STRING,\n  error_message STRING,\n  executed_at TIMESTAMP\n);\n</code></pre></p>"},{"location":"architecture/#agent_memory","title":"\ud83d\udd39 AGENT_MEMORY","text":"<p>Persistent, queryable memory for time travel and audits. <pre><code>CREATE TABLE AGENT_MEMORY (\n  run_id STRING,\n  agent_id STRING,\n  memory_type STRING,          -- conversation / tool / scratchpad\n  content VARIANT,\n  created_at TIMESTAMP\n);\n</code></pre></p>"},{"location":"architecture/#agent_evaluations-optional-v2","title":"\ud83d\udd39 AGENT_EVALUATIONS (Optional / v2)","text":"<p>Post-run scoring. <pre><code>CREATE TABLE AGENT_EVALUATIONS (\n  run_id STRING,\n  metric_name STRING,\n  metric_value FLOAT,\n  evaluated_at TIMESTAMP\n);\n</code></pre></p>"},{"location":"architecture/#2-architecture-flow","title":"2\ufe0f\u20e3 Architecture Flow","text":"<pre><code>graph TD\n    User[User / API / Schedule] --&gt;|Trigger| Runtime[External Agent Runtime]\n    Runtime --&gt;|1. Load Definition| Defs[Snowflake: AGENT_DEFINITIONS]\n    Runtime --&gt;|2. Execute Step| Cortex[Snowflake Cortex (LLM)]\n    Runtime --&gt;|3. Persist State| State[Snowflake: RUNS / STEPS / MEMORY]\n    State --&gt;|4. Analytics| Analytics[Snowflake Analytics &amp; Monitoring]</code></pre>"},{"location":"architecture/#separation-of-concerns","title":"\ud83e\udde0 Separation of Concerns","text":"Component Responsibility Snowflake State, memory, audit, governance, system of record Cortex Model inference (via Adapter) Runtime Execution, retries, orchestration, stateless logic"},{"location":"architecture/#3-cortex-calls-abstraction","title":"3\ufe0f\u20e3 Cortex Calls &amp; Abstraction","text":""},{"location":"architecture/#goal","title":"\ud83c\udfaf Goal","text":"<p>We want Cortex today, other models tomorrow. No agent logic should be tied to a single model.</p>"},{"location":"architecture/#cortex-adapter-pattern","title":"\ud83e\udde9 Cortex Adapter Pattern","text":"<p>Interface (Conceptual) <pre><code>class LLMProvider:\n    def generate(self, prompt: str, config: dict) -&gt; LLMResult:\n        ...\n</code></pre></p> <p>Cortex Implementation <pre><code>class CortexProvider(LLMProvider):\n    def generate(self, prompt: str, config: dict) -&gt; LLMResult:\n        # call SNOWFLAKE.CORTEX.COMPLETE(...)\n        # standardized metrics logging\n        return LLMResult(\n            text=\"...\",\n            tokens=123,\n            latency_ms=456\n        )\n</code></pre></p>"},{"location":"architecture/#governance-advantage","title":"\ud83d\udd10 Governance Advantage","text":"<ul> <li>All calls go through a single adapter.</li> <li>Tokens, cost, and latency are logged centrally.</li> <li>Results are persisted to Snowflake.</li> <li>Result: Centralized control, easy cost guardrails, enterprise observability.</li> </ul> <ul> <li>\u274c Executing uncontrolled Python loops in Snowflake.</li> <li>\u274c Turning Snowflake into an app server.</li> </ul>"},{"location":"architecture/#4-high-scale-distributed-execution","title":"4\ufe0f\u20e3 High-Scale Distributed Execution","text":"<p>The runtime is designed for high throughput using a parallel worker model.</p>"},{"location":"architecture/#parallel-worker-pool","title":"\u26a1 Parallel Worker Pool","text":"<ul> <li>Uses <code>ThreadPoolExecutor</code> (configurable <code>max_workers</code>) to process multiple agents simultaneously.</li> <li>Main thread handles Batch Polling (<code>LIMIT N</code>), reducing database round-trips.</li> <li>Worker threads execute agent logic independently.</li> </ul>"},{"location":"architecture/#concurrency-safety","title":"\ud83d\udee1\ufe0f Concurrency Safety","text":"<ul> <li>Atomic-ish Claiming: The runtime performs an <code>UPDATE</code> on pending rows to lock them before processing, preventing race conditions between multiple runtime instances.</li> <li>Graceful Shutdown: Handles <code>SIGINT</code> (Ctrl+C) to finish active jobs before stopping, ensuring no run is left in an undefined state.</li> </ul>"},{"location":"architecture/#5-security-governance-enterprise-grade","title":"5\ufe0f\u20e3 Security &amp; Governance (Enterprise Grade)","text":"<p>Snowflake teams care deeply about who can do what. This runtime behaves like a native Snowflake object.</p>"},{"location":"architecture/#role-based-access-control-rbac","title":"\ud83d\udee1\ufe0f Role-Based Access Control (RBAC)","text":"Role Permissions SYSADMIN / AGENT_ADMIN Can creates, update, and delete entries in <code>AGENT_DEFINITIONS</code>. ANALYST / USER Can insert into <code>AGENT_RUNS</code> to trigger execution. Read-only on definitions. RUNTIME_SERVICE Needs <code>SELECT</code> on inputs and <code>INSERT</code> on results (<code>AGENT_RUNS</code>, <code>AGENT_STEPS</code>)."},{"location":"architecture/#secret-management","title":"\ud83d\udd10 Secret Management","text":"<ul> <li>Do NOT store secrets in YAML definitions.</li> <li>Use Snowflake Secrets Objects (<code>CREATE SECRET ...</code>) and reference them in the agent config.</li> <li>The Runtime passes the secret reference to Cortex, keeping the value secure.</li> </ul>"},{"location":"architecture/#audit-trail","title":"\ud83d\udcdc Audit Trail","text":"<p>The <code>AGENT_STEPS</code> table is append-only. - Every tool call is logged. - Every model response is logged. - Every retry is logged. This provides a complete forensic audit trail for compliance.</p>"},{"location":"getting-started/","title":"Getting Started","text":"<p>This guide will help you set up the Cortex Agent Runtime and run your first agent.</p>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.9+</li> <li>Snowflake Account: You need access to a specific database and schema.</li> <li>SnowSQL (Optional): Useful for running setup scripts.</li> </ul>"},{"location":"getting-started/#installation","title":"Installation","text":"<ol> <li> <p>Clone the repository:    <pre><code>git clone https://github.com/your-repo/cortex-agent-runtime.git\ncd cortex-agent-runtime\n</code></pre></p> </li> <li> <p>Install dependencies:    <pre><code>pip install -r requirements.txt\n</code></pre></p> </li> </ol>"},{"location":"getting-started/#running-the-basic-agent-example","title":"Running the Basic Agent Example","text":"<p>We have included a \"Basic Agent\" example in the <code>examples/</code> directory.</p>"},{"location":"getting-started/#1-setup-snowflake-environment","title":"1. Setup Snowflake Environment","text":"<p>Run the SQL setup script to create the necessary tables (<code>AGENT_DEFINITIONS</code>, <code>AGENT_RUNS</code>, etc.).</p> <pre><code>cd examples/basic_agent\nsnowsql -f setup_schema.sql -D database=YOUR_DB -s schema=YOUR_SCHEMA\n</code></pre>"},{"location":"getting-started/#2-configure-credentials","title":"2. Configure Credentials","text":"<p>Export your Snowflake credentials as environment variables:</p> <pre><code>export SNOWFLAKE_ACCOUNT=\"&lt;your_account&gt;\"\nexport SNOWFLAKE_USER=\"&lt;your_user&gt;\"\nexport SNOWFLAKE_PASSWORD=\"&lt;your_password&gt;\"\nexport SNOWFLAKE_WAREHOUSE=\"&lt;your_warehouse&gt;\"\nexport SNOWFLAKE_DATABASE=\"&lt;your_database&gt;\"\nexport SNOWFLAKE_SCHEMA=\"&lt;your_schema&gt;\"\n</code></pre>"},{"location":"getting-started/#3-run-the-agent","title":"3. Run the Agent","text":"<p>Execute the Python script:</p> <pre><code>python run.py\n</code></pre> <p>You should see logs indicating that the agent connected to Snowflake, registered itself, and executed the steps defined in <code>agent.yaml</code>.</p>"},{"location":"getting-started/#4-advanced-configuration-optional","title":"4. Advanced Configuration (Optional)","text":"<p>You can tune the runtime performance using environment variables:</p> Variable Default Description <code>CR_MAX_WORKERS</code> <code>10</code> Number of parallel threads for executing agents. <code>CR_FETCH_LIMIT</code> <code>10</code> Number of jobs to fetch per polling cycle. <pre><code>export CR_MAX_WORKERS=50\nexport CR_FETCH_LIMIT=50\npython run.py\n</code></pre>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>Explore the Architecture to understand how it works under the hood.</li> <li>Check the Database Schema reference.</li> <li>Try creating your own agent by modifying <code>agent.yaml</code>.</li> </ul>"},{"location":"schema/","title":"Snowflake Database Schema","text":"<p>This document details the database schema used by the Cortex Agent Runtime. These tables act as the Control Plane for the agent execution.</p>"},{"location":"schema/#1-agent_definitions","title":"1. AGENT_DEFINITIONS","text":"<p>Defines what an agent is. Config-first, versioned, auditable.</p> <pre><code>CREATE TABLE IF NOT EXISTS AGENT_DEFINITIONS (\n  agent_id STRING NOT NULL PRIMARY KEY,\n  agent_name STRING NOT NULL,\n  version STRING NOT NULL,\n  definition_yaml VARIANT,     -- The full config\n  model STRING,                -- Cortex model reference\n  retry_policy VARIANT,\n  status STRING,               -- active / deprecated\n  created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),\n  updated_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()\n);\n</code></pre>"},{"location":"schema/#2-agent_runs","title":"2. AGENT_RUNS","text":"<p>One row per execution. Tracks cost, latency, and status.</p> <pre><code>CREATE TABLE IF NOT EXISTS AGENT_RUNS (\n  run_id STRING NOT NULL PRIMARY KEY,\n  agent_id STRING NOT NULL,\n  agent_version STRING,\n  status STRING,               -- PENDING / RUNNING / COMPLETED / FAILED\n  triggered_by STRING,         -- user / api / schedule\n  total_tokens NUMBER DEFAULT 0,\n  total_cost NUMBER(10, 4) DEFAULT 0,\n  error_message STRING,\n  start_time TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),\n  end_time TIMESTAMP_NTZ\n);\n</code></pre>"},{"location":"schema/#3-agent_steps","title":"3. AGENT_STEPS","text":"<p>Fine-grained execution trace for debugging and forensics.</p> <pre><code>CREATE TABLE IF NOT EXISTS AGENT_STEPS (\n  step_id STRING NOT NULL PRIMARY KEY,\n  run_id STRING NOT NULL,\n  step_index INTEGER,\n  step_name STRING,\n  step_type STRING,            -- INSTRUCTION / TOOL_USE\n  input VARIANT,\n  output VARIANT,\n  model STRING,\n  tokens_used NUMBER DEFAULT 0,\n  latency_ms NUMBER DEFAULT 0,\n  status STRING,               -- SUCCESS / FAILED\n  error_message STRING,\n  executed_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),\n  FOREIGN KEY (run_id) REFERENCES AGENT_RUNS(run_id)\n);\n</code></pre>"},{"location":"schema/#4-agent_memory","title":"4. AGENT_MEMORY","text":"<p>Persistent, queryable memory for time travel and audits.</p> <pre><code>CREATE TABLE IF NOT EXISTS AGENT_MEMORY (\n  memory_id STRING NOT NULL PRIMARY KEY,\n  run_id STRING NOT NULL,\n  agent_id STRING,\n  memory_type STRING,          -- CONVERSATION / TOOL / SCRATCHPAD\n  key STRING,                  -- Optional key for Key-Value retrieval\n  content VARIANT,\n  created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),\n  FOREIGN KEY (run_id) REFERENCES AGENT_RUNS(run_id)\n);\n</code></pre>"}]}